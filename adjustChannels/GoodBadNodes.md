# Какие ноды могут быть и как из квалифицировать

Есть две категории - каналы и ноды. Нода может иметь несколько каналов, которые дают разную информацию о ноде.
Поэтому надо квалифицировать отдельно каналы, затем по ним стараться определить статус ноды.
В идеале нужно учитывать временной срез и вести учёт изменений статуса ноды со временем. Это требует поддержки базы.

## Ноды

### Вычисляемые свойства

* `possiblePrivate` нода или нет - можно определить по % приватных каналов с нами, отсутствие публичного IP
* `possibleInitiator` - Если большинство каналов открыто нами

### Типы нод:

* _**Vacuum**_ (пылесосы) - они забирают на себя ликвидность
* _**Router**_ (машрутизаторы) - сбалансированные - как отдают, так и принимают
* _**Donor**_ (доноры) - они отдают ликвидность больше, чем забирают
* _**Standing**_ (стоячие) - ничего не делающие узлы. Каналы с ними есть, но движения нет

Подумать здесь ещё над тем, что могут быть ноды, владельцы которых периодиечиски закрывают каналы с нашими нодами специально. Признаки этого могут быть такие:

* **COOPERATIVE_CLOSE**

    Имея такой статус в закрытых каналах, понять, кто был инициаотором - нельзя (API не показывает это). Поэтому, чтобы примерно понять, закрыла ли его удалённая сторона или нет - можно посмотреть на `settled_balance` и `capacity`. Если выполняется условие: capacity > 0 &&  settled_balance/capacity >= 0.98, то можно почти точно сказать, что канал открыли мы, он не был почти использован и какая-то из сторон его закрыла. Допустим, что это другая сторона - в таком случае минусуем её за это каким либо способом. Даже если закрыли мы кооперативно, но если выполнялось условие выше - всё равно нам не выгодна такая нода.
    
* **REMOTE_FORCE_CLOSE**

    Удалённая сторона закрыла канал, причём форс мажором. Если выполняется условие: capacity > 0 &&  settled_balance/capacity >= 0.98, то можно почти точно сказать, что канал открыли мы и он не был почти использован и удалённая сторона его закрыла, причём форс-мажором. В таком случае сильно её минусуем за это каким либо способом.
    
* **LOCAL_FORCE_CLOSE**

    Подумать тут. Пока ещё не решил

### Методы с нашей стороны, которыми мы можем оперировать для улучшения своей сети:

* `channelOpen` - Открыть канал на ноду
* `keep` - ничего не делать
* `ban` - Забанить ноду

## Каналы

### Свойства каналов

* `private` - приватный или нет
* `initiator` - если true - мы создали канал, иначе другая сторона

### Методы с нашей стороны, которыми мы можем оперировать для улучшения своей сети:

* `close` - Закрыть канал
* `keep` - ничего не делать, оставить как есть
* `changeFees` - изменить комиссии

## Детальный разбор

1. Ноды **Vacuum** (также merchants)

    Каналы с нашей стороны быстро истощаются
    Отличительные признаки:
    
    * local_balance < 30%
    * большой процент таких каналов
    * total_satoshis_sent > 0
    * total_satoshis_sent > total_satoshis_received - УБРАТЬ! Это всегда истина
    * private любое значение (см. ниже)
    
    Надо находить такие узлы и открывать с ними новые каналы с ликвидностью, но только если private == false
    
    * private == false
        
        Тип: **Merchant (vacuum)**
        
        Ценные ноды. Скорее всего магазины и биллинги. Открывать с ними больше каналов.
        
    * private == true
    
        Тип: **Private merchant (vacuum)**
        
        Сюда могут входить кошельки BLW, например, или ноды, которые открыли канал через наш сервис
    
2. Ноды **Router** (маршрутизаторы)

    Каналы то истощаются, то снова возвращаются.
     
    * local_balance > 0 (в начале может быть == 0, если они открыли и не успели пройти первые платежи)
    * remote_balance > 0 (в начале может быть == 0, если открыли канал мы и не успели пройти первые плетежи)
    * total_satoshis_sent > 0 && total_satoshis_received > 0
    * private == false
    
    Подраздел на:
    
    * `initiator == true`
    
        Канал открывали на него мы
        
        Возможно надо открывать больше каналов с ликвидностью с такими нодами
        
    * initiator == false
      
        Канал открывал он на нас
        
        Возможно надо открывать больше каналов с ликвидностью с такими нодами, если возможно
        
    Тип: **Balanced routing node (passive|active)**
    
    Если с такой нодой много каналов с `initiator == true`, то она `passive`, иначе `active`
    
    Пример `active` ноды, причём она много передела в нашем направлении, чем мы в её, скорее всего это *Donor*, нежели *Router*

        {
            "active": false,
            "remote_pubkey": "020d41c5a32f06d7addc7378f2d4a6596358d8716a3eb5d5bbdd894a82a1fdd00c",
            "channel_point": "61c39fa09fd15000fc2dd328b612f1d682be5e8dfaba52959b6334bcd56153e1:0",
            "chan_id": "605974943105024000",
            "capacity": "100000",
            "local_balance": "72784",
            "remote_balance": "27032",
            "commit_fee": "184",
            "commit_weight": "724",
            "fee_per_kw": "253",
            "unsettled_balance": "0",
            "total_satoshis_sent": "13850",
            "total_satoshis_received": "86634",
            "num_updates": "617",
            "pending_htlcs": [
            ],
            "csv_delay": 144,
            "private": false,
            "initiator": false
        }
     
3. Ноды **Donor** (доноры, также как *плательщики*)

    Это те, кто включили канал на нас (`"initiator": false`) и отправляют в нашу сторону больше.
    
    * total_satoshis_received > total_satoshis_sent && total_satoshis_received / (total_satoshis_sent || 1) >= 2 
    * initiator == false
    * private любой - см. ниже
    
    Если local_balance > remote_balance, то значит они очень хорошо отправляют в нашу сторону, чем мы в их
    
    * `private == true`
    
        типичный узел, созданный для оплаты. Канал на него не создавать,
        но и не закрывать с ним. Скорее всего это либо мобильный кошелёк, либо частная нода. Ещё один признак - смена история поля `"active"` на `false/true`. Если такое есть - скорее всего мобильный кошелёк, либо домашняя нода.
        
        Тип: **Wallet (donor)**
    
    * `private == false`
    
        Канал публичный и он явно донор.
        В таком случае это говорит о том, что этот узел имеет больше каналов исходящих с ликвидностью, чем входящих и он плохо сбалансирован.
        Тут вижу два сценария:
        
        * Либо узел платит сам через нас (нода публичная, но владелец запустил её, чтобы платить)
        
            В этом случае нам не выгодно создавать на него канал, скорее всего
            
            Тип: **Wallet (donor)**
        
        * Либо узел плохо сбалансирован, является routing node (unbalanced)
        
            В данном случае в наших интересах создать на него новый канал с ликвидностью, чтобы на том узле заработала маршрутизация.
            
            Тип: **Liquid node (unbalanced)**
            
        Определить какой тип, скорее всего, можно определить только после открытия на него каналов с ликвидностью.
        Если часть каналов после будет показывать тип
        
    Пример:
    
        {
            "active": true,
            "remote_pubkey": "020de548b86e373e795e37343c9ef6f972d45ade479cc71ed5a9a7dac2588d0a37",
            "channel_point": "1cc6eb3d85ff8a37a19b30d47a14adf58cd77195a8652bd19b62cbf7047d3105:0",
            "chan_id": "615339483518861312",
            "capacity": "5000000",
            "local_balance": "2921464",
            "remote_balance": "2072206",
            "commit_fee": "6330",
            "commit_weight": "724",
            "fee_per_kw": "8743",
            "unsettled_balance": "0",
            "total_satoshis_sent": "0",
            "total_satoshis_received": "2921464",
            "num_updates": "258",
            "pending_htlcs": [
            ],
            "csv_delay": 600,
            "private": false,
            "initiator": false
        },
    
4. **Standing/Vampire** - Мёртвые ноды с каналами на них

    Те ноды, где много таких каналов, как:
    
    * Канал открыт давно (срок можно вычислить по блоку в chan_id или channel_point)
    * Большой процент таких каналов
    * local_balance > 0 && initiator == true && remote_balance == 0
    * `private` любое значение
    
    Разные сценарии, в зависимости от `private`
    
    * `private == false`
        
        Такая нода публичная, но платежи не идут, а значит, скорее всего они не имеют исходящих каналов с ликвидностью у себя.
        
        Тут важно посмотреть `active`:
        
        * `active == true`
        
            Узел в сети, а значит есть вероятность, что заработает. **Оставлять канал как можно дольше**
            
            Тип: **Useless**
            
        * `active == false`
        
            Узел в оффлайне. Возможно, такой узел и не заработает. Не представляет ценности
            **Закрыть канал как можно скорее.** Скорее всего не кооперативно
            **После занести ноду в список нежелательных**
            
            Тип: **Vampire**
        
    * `private == true`
    
        Нода приватная, скорее всего могли открыть через наш сервис, но им не пользуются.
        Закрыть канал, если он существует давно. В первую очередь закрыть кооперативно, и если не получилось - некооперативно.
        **После занести ноду в список нежелательных**
        
        Тип: **Vampire**

5. **Standing/Harmless** - Мёртвые ноды, но каналы открыты на нас

    * Канал открыт давно (срок можно вычислить по блоку в chan_id или channel_point)
    * Большой процент таких каналов
    * remote_balance > 0 && initiator == false && local_balance == 0

    Не делать с ними ничего, так как они сами открыли канал.
